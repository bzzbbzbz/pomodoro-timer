# POMODORO-2: Доработки Pomodoro (горячие клавиши, активная задача, настройки, окно)

**Created:** 2026-02-03  
**Status:** SPEC_READY  
**Parent:** POMODORO-1  
**Stack:** Python 3.10+, tkinter (stdlib)

## Цель

Доработки приложения Pomodoro: поддержка горячих клавиш на русской раскладке, корректное определение активной задачи, перенос длинного текста задачи, исправление применения настроек времени и паузы, привязка компактного окна к нижнему краю экрана.

---

## Требования

### 1. Горячие клавиши: русская и английская раскладка

- **[REQ-POMODORO-2-01]** Горячие клавиши приложения должны срабатывать независимо от текущей раскладки клавиатуры (английская и русская). Реализация: привязка по скан-коду (keysym_num / keycode) или дублирование биндингов для обоих вариантов keysym (например, «s» и «ы», «p» и «з» для Старт/Пауза и т.д.), чтобы одна и та же физическая клавиша работала в обеих раскладках.

### 2. Активная задача: первая без «+»

- **[REQ-POMODORO-2-02]** Активная задача определяется как **первая строка в списке задач**, которая не начинается с «+» (с учётом пробелов в начале) и не является пустой. Пустые строки игнорируются. Строки с «+» в начале считаются выполненными и не могут быть активной задачей. Логика выбора активной по позиции курсора больше не используется для определения активной задачи.

### 3. Перенос текста активной задачи

- **[REQ-POMODORO-2-03]** Текст активной задачи в компактном режиме (над/под таймером) должен переноситься по словам (word wrap), если не помещается в одну строку в пределах ширины окна. Виджет отображения активной задачи должен допускать многострочный вывод (например, `Label` с `wraplength` или аналог).

### 4. Применение настроек времени помодоро и перерыва

- **[REQ-POMODORO-2-04]** Изменение в настройках «Помодоро (мин)» и «Перерыв (мин)» должно немедленно влиять на таймер: при следующем старте рабочего интервала используется новое значение «Помодоро», при переходе на перерыв — новое значение «Перерыв». Если таймер в состоянии «остановлен» или «пауза», отображаемое время до следующего старта должно соответствовать текущим настройкам (например, при сбросе или при первом старте после смены настроек). Текущий обратный отсчёт при уже запущенном таймере может оставаться без изменения до следующего старта/сброса/перехода на перерыв — допускается «применение при следующем действии».

### 5. Компактное окно: привязка к нижнему краю

- **[REQ-POMODORO-2-05]** При переходе в компактный режим (запуск таймера) окно должно уменьшаться **сверху вниз**, сохраняя **нижний край окна** на месте. То есть нижняя граница окна остаётся фиксированной, верхняя поднимается. Пользователь может заранее разместить окно в нижнем углу экрана — при паузе/остановке и повторном развороте окна оно не должно уезжать за пределы экрана снизу. Реализация: при переключении в компактный режим вычислить текущие координаты окна (x, y) и размер (width, height), задать новый размер (compact width × compact height), установить новую позицию окна так, чтобы нижний левый угол остался на месте: `new_y = y + height - compact_height` (для tk: geometry `WxH+X+Y`, где Y = new_y).

---

## Внешние контракты (поведение)

| Область              | Контракт |
|----------------------|----------|
| Горячие клавиши      | Одна и та же физическая клавиша (например, Старт/Пауза) срабатывает и при EN, и при RU раскладке. |
| Активная задача      | Первая непустая строка без префикса «+» в списке задач; пустые строки пропускаются. |
| Текст задачи         | В компактном режиме текст активной задачи переносится по ширине окна. |
| Настройки времени   | Значения «Помодоро (мин)» и «Перерыв (мин)» применяются к таймеру при следующем старте/сбросе/переходе на перерыв. |
| Геометрия окна       | Компактный режим: размер уменьшается, позиция пересчитывается так, что нижний край окна не двигается. |

---

## Связь с существующим кодом

| Требование            | Затрагиваемые модули (ориентировочно) |
|-----------------------|----------------------------------------|
| REQ-POMODORO-2-01     | Точка привязки горячих клавиш (root или главный frame); при отсутствии глобальных горячих клавиш — добавить биндинги с учётом раскладки. |
| REQ-POMODORO-2-02     | `tasks.py`: логика `get_active_text()` и/или расчёт индекса активной задачи (первая без «+», пустые пропускать). |
| REQ-POMODORO-2-03     | `main.py`: виджет отображения активной задачи (active_label) — установка `wraplength` и при необходимости многострочность. |
| REQ-POMODORO-2-04     | `timer.py`: чтение `work_minutes`/`break_minutes` из конфига при старте и при переходе на перерыв; `settings.py`: сохранение в конфиг уже есть — убедиться, что таймер берёт актуальный конфиг. |
| REQ-POMODORO-2-05     | `main.py`: в `on_run_state_changed` при переходе в компактный режим — вычислить новую Y, задать `geometry("WxH+X+Y")` с новой Y; при возврате в полный режим — аналогично сохранить нижний край (или оставить текущее поведение по соглашению). |

---

## Критерии приёмки

1. Горячие клавиши (если есть) работают при русской раскладке так же, как при английской.
2. Активная задача в интерфейсе — всегда первая строка без «+»; пустые строки не считаются.
3. Длинное название активной задачи переносится в компактном режиме и не обрезается по ширине.
4. После изменения минут помодоро/перерыва в настройках новое значение используется при следующем старте/сбросе/переходе на перерыв.
5. При запуске таймера окно «сжимается» вверх, нижний край остаётся на месте; при размещении в нижнем углу экрана после паузы окно остаётся в видимой области.

---

## Риски и ограничения

- Горячие клавиши: на разных системах скан-коды могут отличаться; предпочтительно тестировать на целевой Windows-раскладке.
- Геометрия: при многомониторной конфигурации расчёт Y выполняется в координатах окна; стандартное поведение tk должно сохраняться.
