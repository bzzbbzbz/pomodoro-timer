# POMODORO-4: Мультиплатформенная поддержка (macOS, Linux)

**Created:** 2026-02-03  
**Status:** SPEC_READY  
**Parent:** POMODORO-1, POMODORO-2, POMODORO-3  
**Stack:** Python 3.10+, tkinter (stdlib), PyInstaller

## Цель

Обеспечить работу приложения Pomodoro на **macOS** и **Linux** при сохранении текущей функциональности на Windows. Сборка бинарников/пакетов под каждую ОС через PyInstaller; платформо-зависимый код (звук, уведомление в панели) вынести за условные проверки и при необходимости реализовать альтернативы для macOS и Linux.

---

## Требования

### 1. Сборка под macOS и Linux

- **[REQ-POMODORO-4-01]** Сборка приложения под целевую ОС выполняется на этой же ОС (или в CI под соответствующей средой). PyInstaller используется для всех платформ; один и тот же исходный код, без форков под платформу.
- **[REQ-POMODORO-4-02]** Spec-файл (или логика в нём) должен быть платформо-зависимым только там, где необходимо: поиск Tcl/Tk DLL (tcl86t.dll, tk86t.dll) и добавление их в `binaries` выполнять **только на Windows** (`if sys.platform == "win32"`). На macOS и Linux стандартные хуки PyInstaller для tkinter достаточны; не включать Windows-специфичные бинарники на других платформах.
- **[REQ-POMODORO-4-03]** Документировать команды сборки для каждой ОС (из корня проекта): Windows — `pyinstaller pomodoro.spec`, macOS/Linux — та же команда при условии установленного PyInstaller и Python с tkinter; при необходимости отдельный spec или флаги (например, `--windowed` на macOS для .app) описать в README или в комментариях spec.

### 2. Конфиг и данные рядом с исполняемым файлом

- **[REQ-POMODORO-4-04]** Логика размещения конфига и задач (папка рядом с exe/скриптом: `config.json`, `tasks.txt`) уже реализована в `config.get_base_dir()`: для frozen-приложения — каталог `sys.executable`, для скрипта — корень проекта. Убедиться, что на macOS и Linux поведение не меняется: конфиг и tasks.txt создаются/читаются в той же папке, что и бинарник (или рабочая директория при запуске скрипта), без хардкода Windows-путей.

### 3. Звук по окончании таймера

- **[REQ-POMODORO-4-05]** На **Windows** сохранить текущее поведение: воспроизведение sound.mp3 через MCI (winmm) при наличии файла.
- **[REQ-POMODORO-4-06]** На **macOS** воспроизводить sound.mp3 при окончании таймера, если файл найден: через вызов внешней команды `afplay <path>` (subprocess, без блокировки UI) или аналог. При отсутствии файла — тихо пропускать.
- **[REQ-POMODORO-4-07]** На **Linux** воспроизводить sound.mp3 при окончании таймера, если файл найден: через вызов внешнего плеера в subprocess (например `aplay`, `paplay`, `ffplay` — с fallback по наличию в PATH) или минимальную библиотеку из stdlib/одной зависимости; без блокировки UI. При отсутствии файла или плеера — тихо пропускать.
- **[REQ-POMODORO-4-08]** Поиск sound.mp3 остаётся общим: при frozen — `sys._MEIPASS`, иначе — рядом с пакетом/проектом. Формат файла (mp3) на macOS/Linux может потребовать наличия afplay/ffplay и т.д.; при невозможности воспроизведения mp3 допускается документировать ограничение или опциональную конвертацию в wav для aplay.

### 4. Мигание / привлечение внимания по окончании таймера

- **[REQ-POMODORO-4-09]** На **Windows** сохранить текущее поведение: мигание окна в панели задач (FlashWindowEx) при окончании интервала.
- **[REQ-POMODORO-4-10]** На **macOS** при окончании таймера привлекать внимание пользователя: по возможности bounce иконки в Dock (через PyObjC/ctypes или subprocess/AppleScript), либо только поднять окно и сфокусировать (tk lift/focus). Если реализация bounce окажется тяжёлой по зависимостям — допускается только поднятие окна.
- **[REQ-POMODORO-4-11]** На **Linux** при окончании таймера привлекать внимание: поднять окно и сфокусировать (tk lift/focus); при возможности использовать механизм «urgent» (например, X11 urgency hint) без обязательных доп. зависимостей. Мигание в панели задачи оставить опциональным или не реализовывать в первой итерации.

### 5. GUI и окно

- **[REQ-POMODORO-4-12]** Окно topmost и прозрачность (alpha): проверить поддержку `root.attributes("-topmost", True)` и `root.attributes("-alpha", ...)` на macOS и Linux в используемой версии tkinter; при отсутствии поддержки alpha на какой-либо платформе — не ломать приложение, использовать значение по умолчанию или отключить прозрачность только на этой платформе с сохранением остального функционала.

### 6. Документация и CI (опционально)

- **[REQ-POMODORO-4-13]** В README или в отдельном разделе документации указать: поддерживаемые платформы (Windows, macOS, Linux), требования (Python 3.10+, tkinter), способ сборки под каждую ОС, расположение config.json и tasks.txt (рядом с исполняемым файлом).
- **[REQ-POMODORO-4-14]** (Опционально.) Настроить CI (GitHub Actions или аналог) для сборки под Windows, macOS и Linux с запуском тестов и публикацией артефактов; при отсутствии времени — оставить задачу на будущее, в спеке зафиксировать только ручные команды сборки.

---

## Внешние контракты (поведение)

| Платформа | Конфиг/задачи | Звук | Внимание (окончание таймера) |
|-----------|----------------|------|------------------------------|
| Windows   | Папка exe/скрипта (config.json, tasks.txt) | MCI, sound.mp3 | FlashWindowEx |
| macOS     | Папка бинарника/скрипта | afplay sound.mp3 (subprocess) | Bounce Dock и/или lift окна |
| Linux     | Папка бинарника/скрипта | aplay/paplay/ffplay sound.mp3 (subprocess) | Lift + focus; опционально X11 urgent |

---

## Критерии приёмки

1. На Windows поведение приложения не изменилось: сборка через `pyinstaller pomodoro.spec`, звук и мигание панели работают как сейчас.
2. На macOS: сборка даёт запускаемый бинарник/.app; конфиг и tasks.txt рядом с ним; по окончании таймера воспроизводится звук (если есть sound.mp3 и afplay) и привлекается внимание (bounce или поднятие окна).
3. На Linux: сборка даёт запускаемый бинарник; конфиг и tasks.txt рядом с ним; по окончании таймера воспроизводится звук (при наличии плеера) и окно поднимается/фокусируется.
4. В коде нет падений из-за Windows-специфичных вызовов на macOS/Linux: все обращения к winmm, FlashWindowEx и т.п. обёрнуты в проверку платформы.

---

## Риски и ограничения

- На части дистрибутивов Linux tkinter или Tcl/Tk могут быть установлены отдельно; README должен это отражать.
- Воспроизведение mp3 на Linux зависит от наличия плеера в PATH; при его отсутствии звук можно не гарантировать.
- Сборка под целевую ОС только на этой ОС (или в соответствующем CI); кросс-компиляция не входит в scope.
